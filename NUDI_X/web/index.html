<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Noodle AI - IoT Vending Machine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dashboard {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
        }

        .chat-container {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.05),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .status-container {
            width: 350px;
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.05),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #00ffcc 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }

        #chatBox {
            flex: 1;
            height: 400px;
            overflow-y: auto;
            padding: 16px;
            margin-bottom: 16px;
            background: rgba(20, 20, 30, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 204, 0.2);
        }

        .msg {
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        .user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            margin-right: 0;
        }

        .ai {
            background: linear-gradient(135deg, #00ffcc 0%, #00d4ff 100%);
            color: #0a0a0a;
            margin-right: auto;
            margin-left: 0;
        }

        .input-area {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        #userInput {
            flex: 1;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #userInput:focus {
            border-color: #00ffcc;
        }

        #userInput::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .btn-primary {
            padding: 14px 24px;
            background: linear-gradient(135deg, #00ffcc 0%, #00d4ff 100%);
            border: none;
            border-radius: 12px;
            color: #0a0a0a;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 204, 0.4);
        }

        .btn-secondary {
            padding: 10px 16px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 14px;
            font-weight: 600;
        }

        .status-value.ready { color: #00ffcc; }
        .status-value.busy { color: #ffd93d; }
        .status-value.error { color: #ff6b6b; }
        .status-value.disconnected { color: #888; }

        .noodle-options {
            margin: 20px 0;
        }

        .noodle-option {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .noodle-option:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .noodle-icon-small {
            font-size: 20px;
            margin-right: 12px;
            width: 30px;
        }

        .noodle-info {
            flex: 1;
        }

        .noodle-name {
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .noodle-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .noodle-status {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 10px;
            background: rgba(0, 255, 204, 0.2);
            color: #00ffcc;
        }

        .control-panel {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-title {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
        }

        .control-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .log-container {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            font-family: monospace;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 4px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.03);
        }

        .log-time {
            color: #00ffcc;
        }

        .log-type {
            color: #ffd93d;
            margin: 0 6px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #00ffcc 0%, #00d4ff 100%);
            border-radius: 12px;
            width: fit-content;
            margin-bottom: 12px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #0a0a0a;
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .connection-status {
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 8px;
            text-align: center;
        }

        .connection-status.connected {
            background: rgba(0, 255, 204, 0.1);
            color: #00ffcc;
        }

        .connection-status.disconnected {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            .status-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="chat-container">
            <div class="header">
                <div class="header-title">üçú Smart Noodle AI</div>
                <div class="header-subtitle">IoT Smart Vending Machine with AI Assistant</div>
                <div id="connectionStatus" class="connection-status disconnected">
                    üîÑ Connecting to server...
                </div>
            </div>

            <div id="chatBox">
                <div class="msg ai">ü§ñ Hello! I'm your Smart Noodle AI Assistant. I can help you order delicious noodles!</div>
                <div class="msg ai">üçΩÔ∏è Available Options:<br>
                    ‚Ä¢ Hot Spicy Ramen üå∂Ô∏è<br>
                    ‚Ä¢ Chicken Noodles üçó<br>
                    ‚Ä¢ Cheese Noodles üßÄ<br>
                    ‚Ä¢ Veg Clear Soup ü•¶</div>
            </div>

            <div class="input-area">
                <input type="text" id="userInput" placeholder="Type your order (e.g., 'I want something spicy')...">
                <button id="sendBtn" class="btn-primary">Send</button>
            </div>
        </div>

        <div class="status-container">
            <div class="header">
                <div class="header-title">‚ö° IoT Device Status</div>
                <div class="header-subtitle">Real-time monitoring and control</div>
            </div>

            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Device Status</div>
                    <div id="deviceStatus" class="status-value disconnected">Disconnected</div>
                </div>
                <div class="status-item">
                    <div class="status-label">MQTT Connection</div>
                    <div id="mqttStatus" class="status-value disconnected">Disconnected</div>
                </div>
                <div class="status-item">
                    <div class="status-label">IR Sensors</div>
                    <div id="irStatus" class="status-value">Idle</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Heating System</div>
                    <div id="heatingStatus" class="status-value">Off</div>
                </div>
            </div>

            <div class="noodle-options">
                <div class="control-title">üçú Quick Select Noodles:</div>
                <div class="noodle-option" onclick="quickSelect(1)">
                    <span class="noodle-icon-small">üå∂Ô∏è</span>
                    <div class="noodle-info">
                        <div class="noodle-name">Hot Spicy Ramen</div>
                        <div class="noodle-desc">Spicy, hot, authentic ramen</div>
                    </div>
                    <div class="noodle-status" id="noodle1Status">Ready</div>
                </div>
                <div class="noodle-option" onclick="quickSelect(2)">
                    <span class="noodle-icon-small">üçó</span>
                    <div class="noodle-info">
                        <div class="noodle-name">Chicken Noodles</div>
                        <div class="noodle-desc">Tender chicken pieces</div>
                    </div>
                    <div class="noodle-status" id="noodle2Status">Ready</div>
                </div>
                <div class="noodle-option" onclick="quickSelect(3)">
                    <span class="noodle-icon-small">üßÄ</span>
                    <div class="noodle-info">
                        <div class="noodle-name">Cheese Noodles</div>
                        <div class="noodle-desc">Creamy, cheesy delight</div>
                    </div>
                    <div class="noodle-status" id="noodle3Status">Ready</div>
                </div>
                <div class="noodle-option" onclick="quickSelect(4)">
                    <span class="noodle-icon-small">ü•¶</span>
                    <div class="noodle-info">
                        <div class="noodle-name">Veg Clear Soup</div>
                        <div class="noodle-desc">Light vegetarian soup</div>
                    </div>
                    <div class="noodle-status" id="noodle4Status">Ready</div>
                </div>
            </div>

            <div class="control-panel">
                <div class="control-title">‚öôÔ∏è Manual Controls:</div>
                <div class="control-buttons">
                    <button onclick="manualDispense(1)" class="btn-secondary">Dispense 1</button>
                    <button onclick="manualDispense(2)" class="btn-secondary">Dispense 2</button>
                    <button onclick="manualDispense(3)" class="btn-secondary">Dispense 3</button>
                    <button onclick="manualDispense(4)" class="btn-secondary">Dispense 4</button>
                    <button onclick="checkStatus()" class="btn-secondary">Refresh Status</button>
                    <button onclick="emergencyStop()" class="btn-secondary" style="background: linear-gradient(135deg, #ff0000 0%, #ff6b6b 100%);">
                        Emergency Stop
                    </button>
                </div>
            </div>

            <div class="log-container" id="deviceLog">
                <div class="log-entry"><span class="log-time">[00:00:00]</span><span class="log-type">[SYSTEM]</span> System initialized</div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = "http://127.0.0.1:8000";  // Change this if your server runs on different IP/port
        
        // Global variables
        let deviceStatus = "disconnected";
        let mqttConnected = false;
        let irSensorsActive = false;
        let heatingSystemActive = false;
        let systemLog = [];
        let lastStatusCheck = 0;
        
        // DOM Elements
        const chatBox = document.getElementById("chatBox");
        const userInput = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const deviceStatusElement = document.getElementById("deviceStatus");
        const mqttStatusElement = document.getElementById("mqttStatus");
        const irStatusElement = document.getElementById("irStatus");
        const heatingStatusElement = document.getElementById("heatingStatus");
        const connectionStatusElement = document.getElementById("connectionStatus");
        const deviceLog = document.getElementById("deviceLog");
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Smart Noodle AI System Initializing...");
            
            // Attach event listeners
            sendBtn.addEventListener("click", sendMessage);
            userInput.addEventListener("keypress", function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Start periodic status checking
            checkDeviceStatus();
            setInterval(checkDeviceStatus, 3000); // Check every 3 seconds
            
            // Add welcome message
            addLog("SYSTEM", "Web interface loaded successfully");
            addLog("SYSTEM", `Connecting to server at ${API_BASE_URL}`);
        });
        
        // Logging function
        function addLog(type, message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timeString}]</span><span class="log-type">[${type}]</span> ${message}`;
            
            deviceLog.appendChild(logEntry);
            deviceLog.scrollTop = deviceLog.scrollHeight;
            
            // Keep only last 15 logs
            const logs = deviceLog.getElementsByClassName('log-entry');
            if (logs.length > 15) {
                logs[0].remove();
            }
            
            // Store in memory
            systemLog.push({time: timeString, type: type, message: message});
            if (systemLog.length > 50) systemLog.shift();
        }
        
        // Update all status displays
        function updateStatusDisplay() {
            // Device status
            deviceStatusElement.textContent = deviceStatus;
            deviceStatusElement.className = "status-value";
            
            if (deviceStatus === "ready") {
                deviceStatusElement.classList.add("ready");
            } else if (deviceStatus.includes("busy") || deviceStatus.includes("dispensing")) {
                deviceStatusElement.classList.add("busy");
            } else if (deviceStatus === "disconnected") {
                deviceStatusElement.classList.add("disconnected");
            } else {
                deviceStatusElement.classList.add("error");
            }
            
            // MQTT status
            mqttStatusElement.textContent = mqttConnected ? "Connected" : "Disconnected";
            mqttStatusElement.className = mqttConnected ? "status-value ready" : "status-value disconnected";
            
            // IR Sensors status
            irStatusElement.textContent = irSensorsActive ? "Active" : "Idle";
            irStatusElement.className = irSensorsActive ? "status-value ready" : "status-value";
            
            // Heating system status
            heatingStatusElement.textContent = heatingSystemActive ? "Heating" : "Off";
            heatingStatusElement.className = heatingSystemActive ? "status-value busy" : "status-value";
            
            // Update connection status
            if (deviceStatus === "ready" && mqttConnected) {
                connectionStatusElement.textContent = "‚úÖ Connected to server and devices";
                connectionStatusElement.className = "connection-status connected";
            } else if (!mqttConnected) {
                connectionStatusElement.textContent = "‚ùå MQTT Disconnected - Check server";
                connectionStatusElement.className = "connection-status disconnected";
            } else {
                connectionStatusElement.textContent = "üîÑ Connecting...";
                connectionStatusElement.className = "connection-status disconnected";
            }
            
            // Update noodle status indicators
            if (deviceStatus === "ready") {
                ["noodle1Status", "noodle2Status", "noodle3Status", "noodle4Status"].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = "Ready";
                        element.style.background = "rgba(0, 255, 204, 0.2)";
                        element.style.color = "#00ffcc";
                    }
                });
            } else if (deviceStatus.includes("noodle_")) {
                const noodleNumber = deviceStatus.split("_")[2];
                ["noodle1Status", "noodle2Status", "noodle3Status", "noodle4Status"].forEach((id, index) => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (index + 1 == noodleNumber) {
                            element.textContent = "Dispensing";
                            element.style.background = "rgba(255, 215, 0, 0.3)";
                            element.style.color = "#ffd700";
                        } else {
                            element.textContent = "Waiting";
                            element.style.background = "rgba(255, 255, 255, 0.1)";
                            element.style.color = "#888";
                        }
                    }
                });
            }
        }
        
        // Check device status from server
        async function checkDeviceStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/status`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Update device status
                deviceStatus = data.device_status || "disconnected";
                mqttConnected = data.mqtt_connected || false;
                
                // Simulate IR and heating status based on device status (for demo)
                if (deviceStatus.includes("dispensing")) {
                    irSensorsActive = true;
                    setTimeout(() => {
                        irSensorsActive = false;
                        heatingSystemActive = true;
                        addLog("SYSTEM", "Drop detected, starting heating process");
                    }, 2000);
                } else if (deviceStatus === "ready") {
                    irSensorsActive = false;
                    heatingSystemActive = false;
                }
                
                updateStatusDisplay();
                lastStatusCheck = Date.now();
                
            } catch (error) {
                console.error("Status check error:", error);
                deviceStatus = "disconnected";
                mqttConnected = false;
                updateStatusDisplay();
                
                // Only log connection errors occasionally
                if (Date.now() - lastStatusCheck > 10000) {
                    addLog("ERROR", `Cannot connect to server: ${error.message}`);
                    addLog("INFO", `Make sure server is running at ${API_BASE_URL}`);
                }
            }
        }
        
        // Quick select noodle function
        function quickSelect(noodleNumber) {
            if (deviceStatus !== "ready") {
                addMessage("ai", `‚ö†Ô∏è Device is busy (${deviceStatus}). Please wait.`);
                return;
            }
            
            const noodleNames = ["Hot Spicy Ramen", "Chicken Noodles", "Cheese Noodles", "Veg Clear Soup"];
            const noodleName = noodleNames[noodleNumber - 1];
            const messages = [
                `I want ${noodleName.toLowerCase()}`,
                `Give me ${noodleName}`,
                `I'd like the ${noodleName}`,
                `Order ${noodleName} please`,
                `Can I have ${noodleName}?`
            ];
            
            // Set input value and send
            userInput.value = messages[Math.floor(Math.random() * messages.length)];
            sendMessage();
        }
        
        // Manual dispense function
        async function manualDispense(noodleNumber) {
            if (deviceStatus !== "ready") {
                addMessage("ai", `‚ö†Ô∏è Device is busy (${deviceStatus}). Please wait.`);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/manual_dispense`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ noodle_number: noodleNumber })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const noodleNames = ["Hot Spicy Ramen", "Chicken Noodles", "Cheese Noodles", "Veg Clear Soup"];
                    addMessage("user", `Manual order: ${noodleNames[noodleNumber - 1]}`);
                    addMessageWithTyping("ai", `Dispensing ${noodleNames[noodleNumber - 1]}... Please wait for drop detection.`);
                    addLog("MANUAL", `Manual dispense noodle ${noodleNumber}`);
                } else {
                    addMessage("ai", `‚ùå Failed to dispense: ${data.message}`);
                }
            } catch (error) {
                console.error("Manual dispense error:", error);
                addMessage("ai", "‚ùå Failed to send manual command. Check server connection.");
                addLog("ERROR", "Manual dispense failed");
            }
        }
        
        // Check status function
        function checkStatus() {
            addLog("SYSTEM", "Manual status refresh requested");
            checkDeviceStatus();
            addMessage("ai", "üîÑ Refreshing device status...");
        }
        
        // Emergency stop function
        async function emergencyStop() {
            if (confirm("‚ö†Ô∏è Are you sure you want to emergency stop? This will halt all operations.")) {
                addLog("EMERGENCY", "Emergency stop activated");
                
                try {
                    const response = await fetch(`${API_BASE_URL}/emergency_stop`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    addMessage("user", "EMERGENCY STOP");
                    addMessage("ai", "‚ö†Ô∏è All operations stopped. System reset required.");
                    
                    // Reset status
                    deviceStatus = "disconnected";
                    irSensorsActive = false;
                    heatingSystemActive = false;
                    updateStatusDisplay();
                    
                } catch (error) {
                    console.error("Emergency stop error:", error);
                    addMessage("ai", "‚ö†Ô∏è Emergency stop command sent. System resetting...");
                }
            }
        }
        
        // Chat functions
        function addMessage(sender, text) {
            const div = document.createElement("div");
            div.className = "msg " + sender;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function addMessageWithTyping(sender, text, speed = 30) {
            const div = document.createElement("div");
            div.className = "msg " + sender;
            div.innerText = "";
            chatBox.appendChild(div);
            
            let index = 0;
            
            return new Promise((resolve) => {
                const typeChar = () => {
                    if (index < text.length) {
                        div.textContent = text.substring(0, index + 1);
                        index++;
                        chatBox.scrollTop = chatBox.scrollHeight;
                        setTimeout(typeChar, speed);
                    } else {
                        resolve();
                    }
                };
                typeChar();
            });
        }
        
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            chatBox.appendChild(indicator);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Main send message function
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // Add user message
            addMessage("user", message);
            userInput.value = "";
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_message: message })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Process response
                let aiResponse = data.reply || "Sorry, I didn't understand that.";
                
                // Add additional info if available
                if (data.action) {
                    aiResponse += `\n\n[${data.action}]`;
                    addLog("ACTION", data.action);
                }
                if (data.warning) {
                    aiResponse += `\n\n‚ö†Ô∏è ${data.warning}`;
                }
                if (data.error) {
                    aiResponse += `\n\n‚ùå ${data.error}`;
                    addLog("ERROR", data.error);
                }
                
                // Add AI response with typing animation
                await addMessageWithTyping("ai", aiResponse.trim(), 30);
                
                // Update device status from response
                if (data.device_status) {
                    deviceStatus = data.device_status;
                    updateStatusDisplay();
                }
                
                // Log the interaction
                addLog("CHAT", `User: "${message}"`);
                
            } catch (error) {
                console.error("Chat error:", error);
                removeTypingIndicator();
                
                let errorMessage = "‚ö†Ô∏è Server not responding. Please check:\n";
                errorMessage += "1. FastAPI server is running (uvicorn main:app)\n";
                errorMessage += "2. Server URL is correct\n";
                errorMessage += "3. Network connection is stable";
                
                addMessage("ai", errorMessage);
                addLog("ERROR", `Chat server connection failed: ${error.message}`);
            }
        }
        
        // Auto-scroll chat to bottom
        setInterval(() => {
            chatBox.scrollTop = chatBox.scrollHeight;
        }, 100);
        
        // Simulate periodic system updates
        setInterval(() => {
            if (deviceStatus === "ready" && mqttConnected) {
                // Random system updates
                const updates = [
                    "System nominal",
                    "All sensors operational",
                    "Temperature stable",
                    "Ready for orders",
                    "Water level adequate",
                    "Heating system ready"
                ];
                const randomUpdate = updates[Math.floor(Math.random() * updates.length)];
                
                // Only update occasionally (10% chance)
                if (Math.random() < 0.1) {
                    addLog("SYSTEM", randomUpdate);
                }
            }
        }, 15000);
    </script>

</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Noodle AI - IoT Vending Machine</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%); min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
        .dashboard { width: 100%; max-width: 1200px; display: flex; flex-wrap: wrap; gap: 24px; }
        .chat-container, .status-container { flex: 1; min-width: 300px; background: rgba(30, 30, 46, 0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05); }
        .status-container { width: 350px; }
        .header { text-align: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header-title { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #00ffcc 0%, #00d4ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-subtitle { font-size: 14px; color: rgba(255,255,255,0.6); }
        #connectionStatus { font-size: 12px; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.05); margin-top: 8px; text-align: center; }
        .connected { background: rgba(0,255,204,0.1); color: #00ffcc; }
        .disconnected { background: rgba(255,107,107,0.1); color: #ff6b6b; }
        #chatBox { height: 400px; overflow-y: auto; padding: 16px; margin-bottom: 16px; background: rgba(20,20,30,0.7); border-radius: 12px; border: 1px solid rgba(0,255,204,0.2); }
        .msg { padding: 12px 16px; margin-bottom: 12px; border-radius: 12px; max-width: 85%; word-wrap: break-word; animation: fadeIn 0.3s; }
        .user { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: auto; }
        .ai { background: linear-gradient(135deg, #00ffcc 0%, #00d4ff 100%); color: #0a0a0a; margin-right: auto; }
        .input-area { display: flex; gap: 10px; }
        #userInput { flex: 1; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; outline: none; }
        #userInput:focus { border-color: #00ffcc; }
        .btn-primary { padding: 14px 24px; background: linear-gradient(135deg, #00ffcc 0%, #00d4ff 100%); border: none; border-radius: 12px; color: #0a0a0a; font-weight: 600; cursor: pointer; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,255,204,0.4); }
        .btn-secondary { padding: 10px 16px; background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0; }
        .status-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .status-label { font-size: 11px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; }
        .status-value.ready { color: #00ffcc; }
        .status-value.busy { color: #ffd93d; }
        .status-value.error, .status-value.disconnected { color: #ff6b6b; }
        .noodle-option { display: flex; align-items: center; padding: 12px; margin: 8px 0; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .noodle-option:hover { background: rgba(255,255,255,0.08); transform: translateX(5px); }
        .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; background: linear-gradient(135deg, #00ffcc 0%, #00d4ff 100%); border-radius: 12px; width: fit-content; margin-bottom: 12px; }
        .typing-indicator span { width: 8px; height: 8px; background: #0a0a0a; border-radius: 50%; animation: typing 1.4s ease-in-out infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%,60%,100% { transform: translateY(0); opacity: 0.7; } 30% { transform: translateY(-10px); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .dashboard { flex-direction: column; } .status-container { width: 100%; } }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="chat-container">
            <div class="header">
                <div class="header-title">üçú Smart Noodle AI</div>
                <div class="header-subtitle">IoT Smart Vending Machine with AI Assistant</div>
                <div id="connectionStatus" class="connection-status disconnected">üîÑ Connecting to server...</div>
            </div>
            <div id="chatBox"></div>
            <div class="input-area">
                <input type="text" id="userInput" placeholder="Type your order (e.g., 'I want something spicy')...">
                <button id="sendBtn" class="btn-primary">Send</button>
            </div>
        </div>
        <div class="status-container">
            <div class="header">
                <div class="header-title">‚ö° IoT Device Status</div>
                <div class="header-subtitle">Real-time monitoring and control</div>
            </div>
            <div class="status-grid">
                <div class="status-item"><div class="status-label">Device Status</div><div id="deviceStatus" class="status-value disconnected">Disconnected</div></div>
                <div class="status-item"><div class="status-label">MQTT Connection</div><div id="mqttStatus" class="status-value disconnected">Disconnected</div></div>
            </div>
            <div class="noodle-options">
                <div class="control-title">üçú Quick Select Noodles:</div>
                <div class="noodle-option" onclick="quickSelect(1)">üå∂Ô∏è Hot Spicy Ramen <div class="noodle-status" id="noodle1Status">Ready</div></div>
                <div class="noodle-option" onclick="quickSelect(2)">üçó Chicken Noodles <div class="noodle-status" id="noodle2Status">Ready</div></div>
                <div class="noodle-option" onclick="quickSelect(3)">üßÄ Cheese Noodles <div class="noodle-status" id="noodle3Status">Ready</div></div>
                <div class="noodle-option" onclick="quickSelect(4)">ü•¶ Veg Clear Soup <div class="noodle-status" id="noodle4Status">Ready</div></div>
            </div>
            <div class="control-panel">
                <div class="control-title">‚öôÔ∏è Manual Controls:</div>
                <div class="control-buttons">
                    <button onclick="manualDispense(1)" class="btn-secondary">Dispense 1</button>
                    <button onclick="manualDispense(2)" class="btn-secondary">Dispense 2</button>
                    <button onclick="manualDispense(3)" class="btn-secondary">Dispense 3</button>
                    <button onclick="manualDispense(4)" class="btn-secondary">Dispense 4</button>
                    <button onclick="checkStatus()" class="btn-secondary">Refresh Status</button>
                    <button onclick="emergencyStop()" class="btn-secondary" style="background: linear-gradient(135deg, #ff0000 0%, #ff6b6b 100%);">Emergency Stop</button>
                </div>
            </div>
            <div class="log-container" id="deviceLog">
                <div class="log-entry"><span class="log-time">[00:00:00]</span><span class="log-type">[SYSTEM]</span> System initialized</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "http://127.0.0.1:8000";  // ‚Üê Changed to localhost (more reliable)

        let deviceStatus = "disconnected";
        let mqttConnected = false;

        const chatBox = document.getElementById("chatBox");
        const userInput = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const connectionStatusElement = document.getElementById("connectionStatus");
        const deviceLog = document.getElementById("deviceLog");

        document.addEventListener('DOMContentLoaded', () => {
            sendBtn.addEventListener("click", sendMessage);
            userInput.addEventListener("keypress", e => { if (e.key === 'Enter') sendMessage(); });
            checkDeviceStatus();
            setInterval(checkDeviceStatus, 3000);
            addMessage("ai", "ü§ñ Hello! I'm your Smart Noodle AI Assistant. I can help you order delicious noodles!");
            addMessage("ai", "üçΩÔ∏è Available Options:<br>‚Ä¢ Hot Spicy Ramen üå∂Ô∏è<br>‚Ä¢ Chicken Noodles üçó<br>‚Ä¢ Cheese Noodles üßÄ<br>‚Ä¢ Veg Clear Soup ü•¶");
        });

        function addLog(type, message) {
            const now = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${now}]</span><span class="log-type">[${type}]</span> ${message}`;
            deviceLog.appendChild(entry);
            deviceLog.scrollTop = deviceLog.scrollHeight;
            if (deviceLog.children.length > 15) deviceLog.children[0].remove();
        }

        function addMessage(sender, text) {
            const div = document.createElement("div");
            div.className = "msg " + sender;
            div.innerHTML = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addMessageWithTyping(sender, text, speed = 30) {
            const div = document.createElement("div");
            div.className = "msg " + sender;
            div.innerText = "";
            chatBox.appendChild(div);
            let i = 0;
            return new Promise(resolve => {
                const type = () => {
                    if (i < text.length) {
                        div.textContent = text.substring(0, i + 1);
                        i++;
                        chatBox.scrollTop = chatBox.scrollHeight;
                        setTimeout(type, speed);
                    } else resolve();
                };
                type();
            });
        }

        function showTypingIndicator() {
            const ind = document.createElement('div');
            ind.className = 'typing-indicator';
            ind.id = 'typingIndicator';
            ind.innerHTML = '<span></span><span></span><span></span>';
            chatBox.appendChild(ind);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeTypingIndicator() {
            const ind = document.getElementById('typingIndicator');
            if (ind) ind.remove();
        }

async function checkDeviceStatus() {
    try {
        const res = await fetch(`${API_BASE_URL}/status`);
        if (!res.ok) {
            const errorText = await res.text();
            console.error(`Status check failed: ${res.status}`, errorText);
            throw new Error(`HTTP ${res.status}: ${errorText.substring(0, 100)}`);
        }
        
        const data = await res.json();
        console.log("Status data:", data); // Debug log
        
        deviceStatus = data.device_status || "disconnected";
        mqttConnected = data.mqtt_connected || false;
        updateStatusDisplay();
        
    } catch (err) {
        console.error("Status check error:", err);
        deviceStatus = "disconnected";
        mqttConnected = false;
        updateStatusDisplay();
        
        // Only show connection error occasionally
        if (!window.lastError || Date.now() - window.lastError > 10000) {
            window.lastError = Date.now();
            console.log("‚ö†Ô∏è Cannot connect to server. Make sure FastAPI is running.");
        }
    }
}
        function updateStatusDisplay() {
            document.getElementById("deviceStatus").textContent = deviceStatus;
            document.getElementById("mqttStatus").textContent = mqttConnected ? "Connected" : "Disconnected";

            if (deviceStatus === "ready" && mqttConnected) {
                connectionStatusElement.textContent = "‚úÖ Fully Connected";
                connectionStatusElement.className = "connection-status connected";
            } else {
                connectionStatusElement.textContent = mqttConnected ? "‚ö†Ô∏è Device busy or not ready" : "‚ùå Backend/MQTT disconnected";
                connectionStatusElement.className = "connection-status disconnected";
            }

            // Simple noodle status indicators
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`noodle${i}Status`);
                if (deviceStatus === "ready") el.textContent = "Ready";
                else if (deviceStatus.includes(`_${i}`)) el.textContent = "Dispensing";
                else el.textContent = "Standby";
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            addMessage("user", message);
            userInput.value = "";
            showTypingIndicator();
            try {
                const res = await fetch(`${API_BASE_URL}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_message: message })
                });
                if (!res.ok) throw new Error("Server error");
                const data = await res.json();
                removeTypingIndicator();
                let reply = data.reply || "I didn't understand that.";
                if (data.action) reply += `\n\n‚ö° ${data.action}`;
                if (data.warning) reply += `\n\n‚ö†Ô∏è ${data.warning}`;
                if (data.error) reply += `\n\n‚ùå ${data.error}`;
                await addMessageWithTyping("ai", reply);
                if (data.device_status) {
                    deviceStatus = data.device_status;
                    updateStatusDisplay();
                }
            } catch (err) {
                removeTypingIndicator();
                addMessage("ai", "‚ùå Could not reach server. Check if FastAPI is running on port 8000.");
            }
        }

        function quickSelect(num) {
            const names = ["Hot Spicy Ramen", "Chicken Noodles", "Cheese Noodles", "Veg Clear Soup"];
            userInput.value = `I want ${names[num-1]}`;
            sendMessage();
        }

        async function manualDispense(num) {
            try {
                const res = await fetch(`${API_BASE_URL}/manual_dispense`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ noodle_number: num })
                });
                const data = await res.json();
                if (data.success) {
                    addMessage("ai", `‚úÖ Dispensing noodle ${num}...`);
                } else {
                    addMessage("ai", `‚ùå ${data.message || "Failed"}`);
                }
            } catch (err) {
                addMessage("ai", "‚ùå Could not reach server for manual dispense.");
            }
        }

        async function emergencyStop() {
            if (!confirm("‚ö†Ô∏è Emergency stop all operations?")) return;
            try {
                await fetch(`${API_BASE_URL}/emergency_stop`, { method: "POST" });
                addMessage("ai", "‚ö†Ô∏è Emergency stop command sent.");
            } catch (err) {
                addMessage("ai", "‚ùå Could not reach server.");
            }
        }

        function checkStatus() {
            addLog("SYSTEM", "Manual status refresh");
            checkDeviceStatus();
        }
    </script>
</body>
</html>